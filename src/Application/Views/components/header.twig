<nav role="navigation" class="navbar navbar-expand-lg fixed-top bg-primary" aria-label="Actions principales et accès aux autres pages">
    <div class="container p-0">
        <div class="d-inline-flex">
            <button type="button" class="btn btn-abs-nav btn-nav me-1 ms-1" data-bs-toggle="collapse" data-bs-target="#verticalNavbar" aria-expanded="false" aria-controls="verticalNavbar">
                <span class="mdi mdi-menu span-nav"></span>
            </button>
            <a class="nav-link active d-flex me-1" href=".">
                <img src="/assets/img/appImg.jpg" alt="Logo" class="rounded-circle logo">
                <p class="appName">{% trans %}AppName{% endtrans %}</p>
            </a>
        </div>

        <div class="d-inline-flex">
            <div class="collapse collapse-horizontal" id="collapseSearch">
                <form class="dropdown input-group flex-nowrap container-searchbar" role="search">
                    <div class="d-flex align-items-center searchbar">
                        <div id="searchbar-assign" class="searchbar-category-container">
                            <div id="assign-button" class="searchbar-category-button" data-bs-toggle="dropdown" aria-expanded="false">
                                <small class="form-text text-muted">Assigné=</small>
                                <small id="assign-value" class="form-text text-muted"></small>
                            </div>
                            <span id="assign-cancel" onclick="resetAssign()" class="text-muted searchbar-category-cancel mdi mdi-close-thick"></span>
                            <ul id="dropdown-assign" class="dropdown-menu dd-nav" data-bs="dropdown">
                                <li>
                                    <button onclick="setAssignedValue(this)" class="dropdown-item dropdown-item-nav" type="button">
                                        None
                                    </button>
                                </li>
                                <li>
                                    <button onclick="setAssignedValue(this)" class="dropdown-item dropdown-item-nav" type="button">
                                        Any
                                    </button>
                                </li>
                                <li>
                                    <button onclick="setAssignedValue(this)" class="dropdown-item dropdown-item-nav" type="button">
                                        NOM Prénom
                                    </button>
                                </li>
                            </ul>
                        </div>
                        <div class="searchbar-input-container">
                            <input type="text" id="searchbar-input" class="form-control" data-bs-toggle="dropdown" aria-expanded="false" placeholder= "{% trans %}InputSearchNav{% endtrans %}" aria-label="Search">
                            <ul id="dropdown-category" class="dropdown-menu dropdown-menu-end dd-nav" data-bs="dropdown">
                                <li>
                                    <button type="button" onclick="showDropdownAssign(event)" class="dropdown-item dropdown-item-nav">
                                        <span class="mdi mdi-account me-2"></span>
                                        Assigné
                                    </button>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <button type="reset" onclick="resetSearchbar()" class="btn searchbar-cancel"><span class="mdi mdi-24px mdi-close-circle"></span></button>
                </form>
            </div>

            <button class="btn btn-abs-nav btn-nav" type="submit" data-bs-toggle="collapse" data-bs-target="#collapseSearch"
                    aria-expanded="false" aria-controls="collapseSearch">
                <span class="mdi mdi-magnify span-nav"></span>
            </button>

            <div class="btn-group-nav">
                <button type="button" class="btn position-relative btn-abs-nav btn-nav me-1" aria-expanded="false" title="Notification"
                        data-bs-toggle="modal" data-bs-target="#userModal" onclick="modalNotification()">
                    <span class="mdi mdi-bell span-nav"></span>
                    <span class="position-absolute top-100 start-100 translate-middle badge rounded-pill bg-danger notification">99+</span>
                </button>
            </div>

            <div class="btn-group-nav">
                <button type="button" class="btn btn-abs-nav btn-nav me-1" data-bs-toggle="dropdown" aria-expanded="false" title="Compte">
                    <span class="mdi mdi-account-circle span-nav"></span>
                </button>
                <ul class="dropdown-menu dropdown-menu-end dd-nav">
                    <li><button class="dropdown-item dropdown-item-nav" type="button" data-bs-toggle="modal"
                                data-bs-target="#userModal" onclick="modalGeneral()"> <span class="mdi mdi-cog-outline me-2"></span>
                            {% trans %}DropDownParameters{% endtrans %}</button></li>
                    <li><hr class="dropdown-divider"></li>

                    <li><button class="dropdown-item dropdown-item-nav" type="button" data-bs-toggle="modal"
                                data-bs-target="#userModal" onclick="modalTheme()"> <span class="mdi mdi-palette-outline me-2"></span>
                            {% trans %}DropDownThemeNav{% endtrans %}</button></li>

                    <li><button class="dropdown-item dropdown-item-nav" type="button"> <span class="mdi mdi-share me-2"></span>
                            {% trans %}DropDownShareNav{% endtrans %}</button></li>
                    <li><hr class="dropdown-divider"></li>

                    <li><form action="{{ url_for('account.logout') }}" method="post">
                            {{ csrf.html | raw }}
                            <button class="dropdown-item dropdown-item-nav" type="submit"> <span class="mdi mdi-exit-run me-2"></span>
                                {% trans %}DropDownDisconnectNav{% endtrans %}</button>
                        </form>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</nav>

<div class="modal fade modal-edit" id="userModal" tabindex="-1" aria-labelledby="userModalLabel" data-bs-backdrop="static" data-bs-keyboard="false" aria-hidden="true" role="dialog">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content bg-secondary">
            <div class="container-fluid d-flex">
                <div class="mt-3 mb-2 pe-2">
                    <h1 class="modal-title fs-5 mb-4 text-center">{% trans %}ParamLiModalNav{% endtrans %}</h1>
                    <ul class="list-group">
                        <li class="sidebar-li rounded" id="modal-btn-general"><button class="btn-user-modal" onclick="modalGeneral()">
                                <span class="mdi mdi-cog-outline me-2"></span> {% trans %}GeneralLiModalNav{% endtrans %}</button> </li>
                        <li class="sidebar-li rounded" id="modal-btn-theme"><button class="btn-user-modal" onclick="modalTheme()">
                                <span class="mdi mdi-palette-outline me-2"></span> {% trans %}ThemeLiModalNav{% endtrans %}</button> </li>
                        <li class="sidebar-li rounded" id="modal-btn-notif"><button class="btn-user-modal" onclick="modalNotification()">
                                <span class="mdi mdi-bell me-2"></span> {% trans %}NotifLiModalNav{% endtrans %}</button> </li>
                    </ul>
                </div>
                <div class="container-fluid p-0">
                    <div class="modal-header">
                        <h1 class="modal-title fs-5" id="userModalLabel">{% trans %}TitreModalNav{% endtrans %}</h1>
                        <button type="button" class="btn-close modal-theme-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div>
                            <h5 id="modal-title-body"></h5>
                            <div class="d-flex align-items-center" id="modal-div-body">

                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" id="btn-close-modal" data-bs-dismiss="modal">{% trans %}CloseModalNav{% endtrans %}</button>
                        <button type="button" class="btn btn-primary">{% trans %}SaveModalNav{% endtrans %}</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let lastPage = "";

    function closePopover(){
        let element = document.getElementById('notif-popover-' + idCat + '-' + idTask);
        if(element !== null) {
            let parent = element.parentElement;
            if (parent !== null) {
                let parent_parent = parent.parentElement;
                if(parent_parent !== null){
                    parent_parent.remove();
                }
            }
        }
    }

    function setActiveModal(newPage){
        closePopover();
        if(lastPage !== ""){
            $('#'+lastPage).removeClass("active")
        }

        lastPage = newPage;
        $('#'+newPage).addClass("active");
    }
    /*  Theme */
    function modalTheme(){
        setActiveModal("modal-btn-theme");
        $('#modal-title-body').html(`{{ 'LabelThemeModalNav'|trans|raw }}`);
        $('#modal-div-body').html(`
            <div class="btn btn-modal-theme" role="button" onclick="setToLightMode()" title="Thème clair">
                <div class="theme-modal-color">
                    <div class="theme-color lightPrimary"></div>
                    <div class="theme-color lightSecondary"></div>
                    <div class="theme-color lightTertiary"></div>
                    <div class="theme-color lightBG"></div>
                </div>
            </div>
            <div class="btn btn-modal-theme" role="button" onclick="setToDarkMode()" title="Thème sombre">
                <div class="theme-modal-color">
                    <div class="theme-color darkPrimary"></div>
                    <div class="theme-color darkSecondary"></div>
                    <div class="theme-color darkTertiary"></div>
                    <div class="theme-color darkBG"></div>
                </div>
            </div>
        `);
    }

    /*  General */
    function modalGeneral() {
        setActiveModal("modal-btn-general");
        $('#modal-title-body').html(`test`);
        $('#modal-div-body').html(`
            <div>

            </div>
        `);
    }

    /*  Notification */
    function modalNotification() {
        setActiveModal("modal-btn-notif");
        $('#modal-title-body').html(`{{ 'TitleNotifModalNav'|trans|raw }}`);
        $('#modal-div-body').html(loadAllNotifications());
        addEventNotif();
    }

    function loadAllNotifications(){
        let values = [[2,5, "03/12/2022"]];
        let res =`<ul class="list-group list-group-flush tasks" data-sortable="tasks">`;

        values.forEach(value =>{
            res += createNotification(value[0],value[1],`{{ 'LabelNotifModalNav'|trans|raw }}` + value[2]);
        });
        res += `</ul>`;
        return res;
    }

    function createNotification(subCatId, taskId, date){
        return `
        <li class="sidebar-li rounded p-2" id="notif-` + subCatId + `-` + taskId +`">
            <div class="d-flex">
                <div class="" onclick="openTaskDetails(`+ subCatId +`,`+ taskId +`)">
                    <label>
                        Nom de la tâche [` + subCatId + `-` + taskId +`], ` + date +`
                    </label>
                </div>
                    <a class="ms-2" data-idCat="` + subCatId + `" data-idTask="` + taskId + `" role="button"
                            data-bs="popover" data-bs-popover="notif-popover" aria-label="Actions de la tâche" onclick="setNotifPopoverValues(`+ subCatId +`,`+ taskId +`)">
                        <span class="mdi mdi-dots-horizontal"></span>
                    </a>
            </div>
        </li>
        `;
    }

    let idCat = "";
    let idTask = "";
    function setNotifPopoverValues(subCatId, taskId){
        idCat = subCatId;idTask = taskId;
    }

    function addEventNotif(){
        $("[data-bs-popover=notif-popover]").popover({
            trigger: 'click',
            placement: 'right',
            customClass: 'popover',
            offset: [0, 0],
            html: true,
            sanitize: false,
            content: () => {
                let moveTrad = `{{'NotifMoveToTaskModalNav'|trans|raw }}`;
                let deleteTrad = `{{'NotifDeleteToTaskModalNav'|trans|raw }}`;
                return `
                <div class="btn-group-vertical" id="notif-popover-` + idCat + `-` + idTask +`" role="group" aria-label="Vertical button group">
                    <button type="button" class="btn btn-sm btn-popover" onclick="moveToSubCategory(`+ idCat +`,`+ idTask +`)">
                            <span class="mdi mdi-archive-outline"></span>` + moveTrad +`</button>
                    <button type="button" class="btn btn-sm btn-popover" onclick="deleteNotification(`+ idCat +`,`+ idTask +`)">
                            <span class="mdi mdi-trash-can"></span> `+ deleteTrad +` </button>
                </div>`;
            }
        })
    }

    function moveToSubCategory(subCatId, taskId){
        let element = document.getElementById('taskViewInfo-' + subCatId + '-' + taskId);
        element.scrollIntoView({block:"center"});
    }

    function deleteNotification(subCatId, taskId){
        $('#notif-' + subCatId + '-' + taskId).remove();
        closePopover();
    }

</script>